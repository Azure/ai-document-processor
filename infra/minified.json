{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","metadata":{"_generator":{"name":"bicep","version":"0.33.93.31351","templateHash":"1366123324201166033"}},"parameters":{"appLocation":{"type":"string","allowedValues":["centralus","eastus2","westeurope","westus2","southeastasia"],"metadata":{"description":"Location for the Static Web App and Azure Function App. Only the following locations are allowed: centralus, eastus2, westeurope, westus2, southeastasia"}},"aoaiLocation":{"type":"string","allowedValues":["Australia East","Brazil South","Canada Central","Canada East","East US","East US 2","France Central","Germany West Central","Japan East","Korea Central","North Central US","Norway East","Poland Central","South Africa North","South Central US","South India","Southeast Asia","Spain Central","Sweden Central","Switzerland North","Switzerland West","UAE North","UK South","West Europe","West US","West US 3"],"metadata":{"description":"Location for the Azure OpenAI account"}},"user_gh_url":{"type":"string","metadata":{"description":"Forked Git repository URL for the Static Web App"}},"userPrincipalId":{"type":"string"},"functionAppName":{"type":"string","defaultValue":"[format('functionapp-{0}-{1}', parameters('environmentName'), uniqueString(format('{0}{1}', parameters('appLocation'), resourceGroup().id)))]"},"staticWebAppName":{"type":"string","defaultValue":"[format('static-{0}-{1}', parameters('environmentName'), uniqueString(format('{0}{1}', parameters('appLocation'), resourceGroup().id)))]"},"location":{"type":"string"},"appInsightsLocation":{"type":"string"},"environmentName":{"type":"string","defaultValue":"dev"},"storageAccountName":{"type":"string","defaultValue":"[format('azfn{0}', uniqueString(format('{0}{1}', parameters('location'), resourceGroup().id)))]"},"keyVaultName":{"type":"string","defaultValue":"[format('keyvault-{0}', uniqueString(format('{0}{1}', parameters('location'), resourceGroup().id)))]"}},"variables":{"tenantId":"[tenant().tenantId]"},"resources":[{"condition":"[not(equals(parameters('userPrincipalId'), ''))]","type":"Microsoft.Authorization/roleAssignments","apiVersion":"2022-04-01","name":"[guid(subscription().subscriptionId, resourceGroup().name, 'functionAppModule', 'contributor')]","properties":{"roleDefinitionId":"[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]","principalId":"[parameters('userPrincipalId')]","principalType":"User"},"dependsOn":["[resourceId('Microsoft.Resources/deployments', 'functionAppModule')]"]},{"type":"Microsoft.Authorization/roleAssignments","apiVersion":"2020-04-01-preview","name":"[guid(resourceGroup().id, 'aoaiModule')]","properties":{"roleDefinitionId":"[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]","principalId":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.identityPrincipalId.value]","principalType":"ServicePrincipal"},"dependsOn":["[resourceId('Microsoft.Resources/deployments', 'aoaiModule')]","[resourceId('Microsoft.Resources/deployments', 'functionAppModule')]"]},{"type":"Microsoft.Authorization/roleAssignments","apiVersion":"2022-04-01","name":"[guid(resourceGroup().id, parameters('keyVaultName'))]","properties":{"roleDefinitionId":"[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]","principalId":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.identityPrincipalId.value]","principalType":"ServicePrincipal"},"dependsOn":["[resourceId('Microsoft.Resources/deployments', 'functionAppModule')]"]},{"type":"Microsoft.Resources/deployments","apiVersion":"2022-09-01","name":"keyVaultModule","properties":{"expressionEvaluationOptions":{"scope":"inner"},"mode":"Incremental","parameters":{"vaultName":{"value":"[parameters('keyVaultName')]"},"location":{"value":"[parameters('location')]"},"tenantId":{"value":"[variables('tenantId')]"}},"template":{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","metadata":{"_generator":{"name":"bicep","version":"0.33.93.31351","templateHash":"685735460431337068"}},"parameters":{"vaultName":{"type":"string"},"location":{"type":"string"},"tenantId":{"type":"string"}},"resources":[{"type":"Microsoft.KeyVault/vaults","apiVersion":"2024-04-01-preview","name":"[parameters('vaultName')]","location":"[parameters('location')]","properties":{"sku":{"family":"A","name":"standard"},"tenantId":"[parameters('tenantId')]","networkAcls":{"bypass":"None","defaultAction":"Allow","ipRules":[],"virtualNetworkRules":[]},"accessPolicies":[],"enabledForDeployment":false,"enabledForDiskEncryption":false,"enabledForTemplateDeployment":false,"enableSoftDelete":true,"softDeleteRetentionInDays":90,"enableRbacAuthorization":true,"vaultUri":"[format('https://{0}{1}/', parameters('vaultName'), environment().suffixes.keyvaultDns)]","provisioningState":"Succeeded","publicNetworkAccess":"Enabled"}}]}}},{"type":"Microsoft.Resources/deployments","apiVersion":"2022-09-01","name":"aoaiModule","properties":{"expressionEvaluationOptions":{"scope":"inner"},"mode":"Incremental","parameters":{"location":{"value":"[parameters('aoaiLocation')]"},"name":{"value":"[format('aoai-{0}', uniqueString(resourceGroup().id))]"}},"template":{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","metadata":{"_generator":{"name":"bicep","version":"0.33.93.31351","templateHash":"7399586362500351798"}},"parameters":{"aiServicesName":{"type":"string","defaultValue":"[format('aiServices-new-{0}', uniqueString(resourceGroup().id))]","metadata":{"description":"That name is the name of our application. It has to be unique.Type a name followed by your resource group name. (<name>-<resourceGroupName>)"}},"name":{"type":"string"},"location":{"type":"string","defaultValue":"[resourceGroup().location]","metadata":{"description":"Location for all resources."}},"customSubDomainName":{"type":"string","defaultValue":"[parameters('name')]"},"sku":{"type":"string","defaultValue":"S0","allowedValues":["S0"]},"deploymentName":{"type":"string","defaultValue":"gpt-4o","metadata":{"description":"Azure OpenAI model deployment name."}},"modelName":{"type":"string","defaultValue":"gpt-4o","metadata":{"description":"Azure OpenAI model name, e.g. \"gpt-35-turbo\"."}}},"resources":[{"type":"Microsoft.CognitiveServices/accounts","apiVersion":"2023-05-01","name":"[parameters('aiServicesName')]","location":"[parameters('location')]","identity":{"type":"SystemAssigned"},"sku":{"name":"[parameters('sku')]"},"kind":"OpenAI","properties":{"customSubDomainName":"[parameters('customSubDomainName')]","publicNetworkAccess":"Enabled"}},{"type":"Microsoft.CognitiveServices/accounts/deployments","apiVersion":"2023-05-01","name":"[format('{0}/{1}', parameters('aiServicesName'), parameters('deploymentName'))]","sku":{"name":"Standard","capacity":30},"properties":{"model":{"format":"OpenAI","name":"[parameters('modelName')]"}},"dependsOn":["[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]"]}],"outputs":{"AOAI_ENDPOINT":{"type":"string","value":"[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), '2023-05-01').endpoint]"}}}}},{"type":"Microsoft.Resources/deployments","apiVersion":"2022-09-01","name":"functionAppModule","properties":{"expressionEvaluationOptions":{"scope":"inner"},"mode":"Incremental","parameters":{"appName":{"value":"[parameters('functionAppName')]"},"location":{"value":"[parameters('appLocation')]"},"appInsightsLocation":{"value":"[parameters('appInsightsLocation')]"},"storageAccountName":{"value":"[parameters('storageAccountName')]"},"aoaiEndpoint":{"value":"[reference(resourceId('Microsoft.Resources/deployments', 'aoaiModule'), '2022-09-01').outputs.AOAI_ENDPOINT.value]"}},"template":{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","metadata":{"_generator":{"name":"bicep","version":"0.33.93.31351","templateHash":"5209286522777115237"}},"parameters":{"appName":{"type":"string","metadata":{"description":"The name of the function app that you wish to create."}},"storageAccountType":{"type":"string","defaultValue":"Standard_LRS","allowedValues":["Standard_LRS","Standard_GRS","Standard_RAGRS"],"metadata":{"description":"Storage Account type"}},"location":{"type":"string","metadata":{"description":"Location for all resources."}},"appInsightsLocation":{"type":"string","metadata":{"description":"Location for Application Insights"}},"runtime":{"type":"string","defaultValue":"python","metadata":{"description":"The language worker runtime to load in the function app."}},"aoaiEndpoint":{"type":"string"},"storageAccountName":{"type":"string"}},"variables":{"functionAppName":"[parameters('appName')]","hostingPlanName":"[parameters('appName')]","applicationInsightsName":"[parameters('appName')]","functionWorkerRuntime":"[parameters('runtime')]","blobEndpoint":"[format('https://{0}.blob.{1}', parameters('storageAccountName'), environment().suffixes.storage)]","promptFile":"prompts.yaml","openaiApiVersion":"2024-05-01-preview","openaiApiBase":"[parameters('aoaiEndpoint')]","openaiModel":"gpt-4o"},"resources":[{"type":"Microsoft.Storage/storageAccounts","apiVersion":"2022-05-01","name":"[parameters('storageAccountName')]","location":"[parameters('location')]","sku":{"name":"[parameters('storageAccountType')]"},"kind":"Storage","properties":{}},{"type":"Microsoft.Web/serverfarms","apiVersion":"2021-03-01","name":"[variables('hostingPlanName')]","location":"[parameters('location')]","sku":{"name":"P0v3","capacity":1},"properties":{"reserved":true},"kind":"linux"},{"type":"Microsoft.Web/sites","apiVersion":"2021-03-01","name":"[variables('functionAppName')]","location":"[parameters('location')]","kind":"functionapp,linux","identity":{"type":"SystemAssigned"},"tags":{"azd-service-name":"myfunctionapp"},"properties":{"serverFarmId":"[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]","siteConfig":{"cors":{"allowedOrigins":["https://ms.portal.azure.com","https://portal.azure.com"]},"alwaysOn":true,"appSettings":[{"name":"AzureWebJobsStorage__accountName","value":"[parameters('storageAccountName')]"},{"name":"AzureWebJobsStorage__credential","value":"managedidentity"},{"name":"FUNCTIONS_EXTENSION_VERSION","value":"~4"},{"name":"APPINSIGHTS_INSTRUMENTATIONKEY","value":"[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2020-02-02').InstrumentationKey]"},{"name":"FUNCTIONS_WORKER_RUNTIME","value":"[variables('functionWorkerRuntime')]"},{"name":"BLOB_ENDPOINT","value":"[variables('blobEndpoint')]"},{"name":"PROMPT_FILE","value":"[variables('promptFile')]"},{"name":"ENABLE_ORYX_BUILD","value":"true"},{"name":"SCM_DO_BUILD_DURING_DEPLOYMENT","value":"true"},{"name":"OPENAI_API_VERSION","value":"[variables('openaiApiVersion')]"},{"name":"OPENAI_API_BASE","value":"[parameters('aoaiEndpoint')]"},{"name":"OPENAI_MODEL","value":"[variables('openaiModel')]"}],"ftpsState":"FtpsOnly","linuxFxVersion":"Python|3.11","minTlsVersion":"1.2"},"httpsOnly":true},"dependsOn":["[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]","[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]","[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"]},{"type":"Microsoft.Web/sites/config","apiVersion":"2022-03-01","name":"[format('{0}/{1}', variables('functionAppName'), 'authsettingsV2')]","properties":{"globalValidation":{"requireAuthentication":false},"platform":{"enabled":false}},"dependsOn":["[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"]},{"type":"Microsoft.Insights/components","apiVersion":"2020-02-02","name":"[variables('applicationInsightsName')]","location":"[parameters('appInsightsLocation')]","kind":"web","properties":{"Application_Type":"web","Request_Source":"rest"}},{"type":"Microsoft.Storage/storageAccounts/blobServices","apiVersion":"2022-09-01","name":"[format('{0}/{1}', parameters('storageAccountName'), 'default')]","dependsOn":["[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"]},{"type":"Microsoft.Storage/storageAccounts/blobServices/containers","apiVersion":"2022-09-01","name":"[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'bronze')]","properties":{"publicAccess":"None"},"dependsOn":["[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"]},{"type":"Microsoft.Storage/storageAccounts/blobServices/containers","apiVersion":"2022-09-01","name":"[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'silver')]","properties":{"publicAccess":"None"},"dependsOn":["[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"]},{"type":"Microsoft.Storage/storageAccounts/blobServices/containers","apiVersion":"2022-09-01","name":"[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'gold')]","properties":{"publicAccess":"None"},"dependsOn":["[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"]},{"type":"Microsoft.Storage/storageAccounts/blobServices/containers","apiVersion":"2022-09-01","name":"[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'prompts')]","properties":{"publicAccess":"None"},"dependsOn":["[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"]}],"outputs":{"id":{"type":"string","value":"[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"},"name":{"type":"string","value":"[variables('functionAppName')]"},"uri":{"type":"string","value":"[format('https://{0}', reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2021-03-01').defaultHostName)]"},"identityPrincipalId":{"type":"string","value":"[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2021-03-01', 'full').identity.principalId]"},"location":{"type":"string","value":"[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2021-03-01', 'full').location]"},"storageAccountName":{"type":"string","value":"[parameters('storageAccountName')]"},"blobEndpoint":{"type":"string","value":"[variables('blobEndpoint')]"},"promptFile":{"type":"string","value":"[variables('promptFile')]"},"openaiApiVersion":{"type":"string","value":"[variables('openaiApiVersion')]"},"openaiApiBase":{"type":"string","value":"[variables('openaiApiBase')]"},"openaiModel":{"type":"string","value":"[variables('openaiModel')]"},"functionWorkerRuntime":{"type":"string","value":"[variables('functionWorkerRuntime')]"}}}},"dependsOn":["[resourceId('Microsoft.Resources/deployments', 'aoaiModule')]"]},{"type":"Microsoft.Resources/deployments","apiVersion":"2022-09-01","name":"staticWebAppModule","properties":{"expressionEvaluationOptions":{"scope":"inner"},"mode":"Incremental","parameters":{"staticWebAppName":{"value":"[parameters('staticWebAppName')]"},"functionAppResourceId":{"value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.id.value]"},"user_gh_url":{"value":"[parameters('user_gh_url')]"},"location":{"value":"[parameters('appLocation')]"}},"template":{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","metadata":{"_generator":{"name":"bicep","version":"0.33.93.31351","templateHash":"14343801804519790337"}},"parameters":{"staticWebAppName":{"type":"string"},"functionAppResourceId":{"type":"string"},"user_gh_url":{"type":"string"},"location":{"type":"string"}},"resources":[{"type":"Microsoft.Web/staticSites","apiVersion":"2024-04-01","name":"[parameters('staticWebAppName')]","location":"[parameters('location')]","sku":{"name":"Standard","tier":"Standard"},"identity":{"type":"SystemAssigned"},"properties":{"repositoryUrl":"[parameters('user_gh_url')]","branch":"main","stagingEnvironmentPolicy":"Enabled","allowConfigFileUpdates":true,"provider":"GitHub","enterpriseGradeCdnStatus":"Disabled"}},{"type":"Microsoft.Web/staticSites/basicAuth","apiVersion":"2024-04-01","name":"[format('{0}/{1}', parameters('staticWebAppName'), 'default')]","properties":{"applicableEnvironmentsMode":"SpecifiedEnvironments"},"dependsOn":["[resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName'))]"]},{"type":"Microsoft.Web/staticSites/linkedBackends","apiVersion":"2024-04-01","name":"[format('{0}/{1}', parameters('staticWebAppName'), 'backend1')]","properties":{"backendResourceId":"[parameters('functionAppResourceId')]","region":"[parameters('location')]"},"dependsOn":["[resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName'))]"]}]}},"dependsOn":["[resourceId('Microsoft.Resources/deployments', 'functionAppModule')]"]},{"type":"Microsoft.Resources/deployments","apiVersion":"2022-09-01","name":"functionstorage-access-2","properties":{"expressionEvaluationOptions":{"scope":"inner"},"mode":"Incremental","parameters":{"resourceName":{"value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.storageAccountName.value]"},"principalID":{"value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.identityPrincipalId.value]"}},"template":{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","metadata":{"_generator":{"name":"bicep","version":"0.33.93.31351","templateHash":"2276431317078424194"}},"parameters":{"principalID":{"type":"string"},"resourceName":{"type":"string"}},"variables":{"storageBlobDataOwnerRoleId":"b7e6dc6d-f1e8-4753-8033-0f276bb0955b","ownerRoleId":"8e3af657-a8ff-443c-a75c-2fe8c4bcb635"},"resources":[{"type":"Microsoft.Authorization/roleAssignments","apiVersion":"2020-04-01-preview","scope":"[format('Microsoft.Storage/storageAccounts/{0}', parameters('resourceName'))]","name":"[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName')), parameters('principalID'), variables('storageBlobDataOwnerRoleId'))]","properties":{"roleDefinitionId":"[resourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataOwnerRoleId'))]","principalId":"[parameters('principalID')]","principalType":"ServicePrincipal"}},{"type":"Microsoft.Authorization/roleAssignments","apiVersion":"2020-04-01-preview","scope":"[format('Microsoft.Storage/storageAccounts/{0}', parameters('resourceName'))]","name":"[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('resourceName')), parameters('principalID'), variables('ownerRoleId'))]","properties":{"roleDefinitionId":"[resourceId('Microsoft.Authorization/roleDefinitions', variables('ownerRoleId'))]","principalId":"[parameters('principalID')]","principalType":"ServicePrincipal"}}]}},"dependsOn":["[resourceId('Microsoft.Resources/deployments', 'functionAppModule')]"]},{"type":"Microsoft.Resources/deployments","apiVersion":"2022-09-01","name":"functionqueue-access-2","properties":{"expressionEvaluationOptions":{"scope":"inner"},"mode":"Incremental","parameters":{"resourceName":{"value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.storageAccountName.value]"},"principalId":{"value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.identityPrincipalId.value]"}},"template":{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","metadata":{"_generator":{"name":"bicep","version":"0.33.93.31351","templateHash":"16239385970959179047"}},"parameters":{"principalId":{"type":"string"},"resourceName":{"type":"string"}},"variables":{"queueContributorRoleId":"[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '974c5e8b-45b9-4653-ba55-5f855dd0fb88')]"},"resources":[{"type":"Microsoft.Authorization/roleAssignments","apiVersion":"2020-04-01-preview","scope":"[format('Microsoft.Storage/storageAccounts/{0}', parameters('resourceName'))]","name":"[guid(resourceGroup().id, parameters('principalId'), variables('queueContributorRoleId'))]","properties":{"roleDefinitionId":"[variables('queueContributorRoleId')]","principalId":"[parameters('principalId')]","principalType":"ServicePrincipal"}}]}},"dependsOn":["[resourceId('Microsoft.Resources/deployments', 'functionAppModule')]"]}],"outputs":{"RESOURCE_GROUP":{"type":"string","value":"[resourceGroup().name]"},"FUNCTION_APP_NAME":{"type":"string","value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.name.value]"},"AZURE_STORAGE_ACCOUNT":{"type":"string","value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.storageAccountName.value]"},"FUNCTION_URL":{"type":"string","value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.uri.value]"},"BLOB_ENDPOINT":{"type":"string","value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.blobEndpoint.value]"},"PROMPT_FILE":{"type":"string","value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.promptFile.value]"},"OPENAI_API_VERSION":{"type":"string","value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.openaiApiVersion.value]"},"OPENAI_API_BASE":{"type":"string","value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.openaiApiBase.value]"},"OPENAI_MODEL":{"type":"string","value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.openaiModel.value]"},"FUNCTIONS_WORKER_RUNTIME":{"type":"string","value":"[reference(resourceId('Microsoft.Resources/deployments', 'functionAppModule'), '2022-09-01').outputs.functionWorkerRuntime.value]"}}}
